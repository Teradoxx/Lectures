FROM ubuntu:latest

RUN apt-get update && apt-get install -y \
    openssh-server \
    apache2 \
    php \
    php-mysql \
    mariadb-server \
    gobuster \
    fail2ban \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /var/run/sshd
RUN echo 'root:password' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

RUN echo "ServerName localhost" >> /etc/apache2/apache2.conf

RUN mkdir -p /var/www/html/backup
RUN echo "<?php \$db_user='admin'; \$db_pass='password123'; ?>" > /var/www/html/backup/db_config.php.bak
RUN echo "FLAG{CTF_SUCCESS}" > /var/www/html/backup/flag.txt

RUN chmod 777 /var/www/html/backup/db_config.php.bak
RUN chmod 777 /var/www/html/backup/flag.txt

RUN id mysql || useradd -r -s /bin/false mysql && \
    chown -R mysql:mysql /var/lib/mysql

RUN mkdir -p /run/mysqld && \
    chown -R mysql:mysql /run/mysqld

COPY init.sql /docker-entrypoint-initdb.d/

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 22 80 3306

CMD ["/entrypoint.sh"]
